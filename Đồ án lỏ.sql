


DROP DATABASE KYTUCXA

CREATE DATABASE KYTUCXA

ON(NAME = KYTUCXA_data, FILENAME = 'Z:\TIE501\Đồ án\KYTUCXA_data.mdf')
LOG ON(NAME = KYTUCXA_log, FILENAME = 'Z:\TIE501\Đồ án\KYTUCXA_log.ldf')

USE KYTUCXA

DROP TABLE LOP
DROP TABLE KHOA
DROP TABLE SINHVIEN
DROP TABLE NHANVIEN
DROP TABLE PHONG 
DROP TABLE HOPDONG
DROP TABLE HOADON


CREATE TABLE SINHVIEN(
	MASINHVIEN VARCHAR(9) CHECK (MASINHVIEN LIKE ('[A-Z][A-Z][A-Z][0-9][0-9][0-9][0-9][0-9][0-9]')) PRIMARY KEY,
	TENSINHVIEN NVARCHAR(50) NOT NULL,
	NGAYSINH DATE,
	GIOITINH NVARCHAR(3) CHECK (GIOITINH IN ('Nam', N'Nữ')),
	NOISINH NVARCHAR(30),
	DIACHI NVARCHAR(50),
	MALOP VARCHAR(10),
	MAKHOA VARCHAR(13),
	CCCD CHAR(12),
	SDT CHAR(10),
	EMAIL VARCHAR(40),

	CONSTRAINT SINHVIEN_KHOA_FK FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA),
    CONSTRAINT SINHVIEN_LOP_FK FOREIGN KEY (MALOP) REFERENCES LOP(MALOP),
) 

CREATE TABLE KHOA(
	MAKHOA VARCHAR(13) PRIMARY KEY,
	TENKHOA NVARCHAR(40) NOT NULL,
	
)

CREATE TABLE LOP(
	MALOP VARCHAR(10) PRIMARY KEY,
	TENLOP CHAR(7) NOT NULL,
	MAKHOA VARCHAR(13),
	CONSTRAINT LOP_KHOA_FK FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA),
)

CREATE TABLE PHONG(
	MAPHONG VARCHAR(12) PRIMARY KEY,
	SOPHONG VARCHAR(10),
	MALOAIPHONG VARCHAR (10),
	TANG NVARCHAR(21),
	SOLUONGSINHVIEN INT CHECK ( SOLUONGSINHVIEN <= 8),
	MATINHTRANGPHONG VARCHAR(10),

	CONSTRAINT PHONG_LOAIPHONG_FK FOREIGN KEY (MALOAIPHONG) REFERENCES LOAIPHONG(MALOAIPHONG),
	CONSTRAINT PHONG_TINHTRANGPHONG_FK FOREIGN KEY (MATINHTRANGPHONG) REFERENCES TINHTRANGPHONG(MATINHTRANGPHONG)

)



CREATE TABLE HOADON(
	MAHOADON VARCHAR (10) PRIMARY KEY,
	MANHANVIEN VARCHAR(13),
	MAPHONG VARCHAR(12),
	NGAYLAP DATE,
	TIENPHONG MONEY CONSTRAINT HOADON_TIENPHONG_DF DEFAULT (1200000),

	TIENDIEN MONEY,
	TIENNUOC MONEY,
	TONGTIEN MONEY,
	CONSTRAINT HOADON_NHANVIEN_FK FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN),
	CONSTRAINT HOADON_PHONG_FK FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG),
)

CREATE TABLE TINHTRANGPHONG(
	MATINHTRANGPHONG VARCHAR(10) PRIMARY KEY,
	TINHTRANGPHONG NVARCHAR(30) NOT NULL
)

CREATE TABLE LOAIPHONG(
	MALOAIPHONG VARCHAR(10) PRIMARY KEY,
	LOAIPHONG NVARCHAR(30) NOT NULL
)



CREATE TABLE NHANVIEN(
	MANHANVIEN VARCHAR(13) PRIMARY KEY,
	TENNHANVIEN NVARCHAR(50) NOT NULL,
	NGAYSINH DATE,
	GIOITINH NVARCHAR(3) CHECK (GIOITINH IN ('Nam', N'Nữ')),
	NOISINH NVARCHAR(30),
	DIACHI NVARCHAR (50),
	CCCD CHAR(12), 
	SDT CHAR(10),
	EMAIL VARCHAR(40)
)

SELECT * FROM NHANVIEN




CREATE TABLE HOPDONG(
	MAHOPDONG VARCHAR(12) PRIMARY KEY,
	MASINHVIEN VARCHAR(9),
	MANHANVIEN VARCHAR(13),
	MAPHONG VARCHAR(12),
	NGAYLAP DATE,
	NGAYBATDAU DATE,
	NGAYKETTHUC DATE,
	CONSTRAINT HOPDONG_SINHVIEN_FK FOREIGN KEY (MASINHVIEN) REFERENCES SINHVIEN(MASINHVIEN),
	CONSTRAINT HOPDONG_NHANVIEN_FK FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN),
	CONSTRAINT HOPDONG_PHONG_FK FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG),
)





INSERT INTO KHOA (MAKHOA, TENKHOA)
VALUES
    ('K001', N'Khoa Công nghệ thông tin'),
    ('K002', N'Khoa Kinh tế'),
    ('K003', N'Khoa Luật'),
    ('K004', N'Khoa Sư phạm'),
    ('K005', N'Khoa Ngoại ngữ');

INSERT INTO LOP (MALOP, TENLOP, MAKHOA)
VALUES
    ('L001', 'DH22TH3', 'K001'),
    ('L002', 'DH21QT', 'K002'),
    ('L003', 'DH23LU', 'K003'),
    ('L004', 'DH22TO', 'K004'),
    ('L005', 'DH24AV', 'K005');



INSERT INTO TINHTRANGPHONG (MATINHTRANGPHONG, TINHTRANGPHONG)
VALUES
    ('TT001', N'Đang sử dụng'),
    ('TT002', N'Trống'),
    ('TT003', N'Đang bảo trì'),
    ('TT004', N'Hỏng hóc');

INSERT INTO LOAIPHONG (MALOAIPHONG, LOAIPHONG)
VALUES
    ('LP001', N'Phòng đơn'),
    ('LP002', N'Phòng điều hòa'),
    ('LP003', N'Phòng thường'),
    ('LP005', N'Phòng VIP');

INSERT INTO PHONG (MAPHONG, SOPHONG, MALOAIPHONG, TANG, SOLUONGSINHVIEN, MATINHTRANGPHONG)
VALUES
    ('P0012345688', '110A', 'LP001', N'Tầng 1', 3, 'TT001'),
    ('P0012345689', '210B', 'LP002', N'Tầng 2', 4, 'TT002'),
    ('P0012345690', '310C', 'LP003', N'Tầng 3', 6, 'TT003'),
    ('P0012345691', '410D', 'LP001', N'Tầng 4', 2, 'TT004'),
    ('P0012345692', '510E', 'LP005', N'Tầng 5', 1, 'TT002');





-- Thêm dữ liệu vào bảng SINHVIEN
INSERT INTO SINHVIEN (MASINHVIEN, TENSINHVIEN, NGAYSINH, GIOITINH, NOISINH, DIACHI, MALOP, MAKHOA, CCCD, SDT, EMAIL)
VALUES
    ('DTH216134', N'Nguyễn Văn A', '2003-05-15', N'Nam', N'Hà Nội', N'123 Đường ABC, Hà Nội', 'L001', 'K001', '123456789012', '0987654321', 'nguyenvana@gmail.com'),
    ('DQT202124', N'Nguyễn Thị B', '2002-07-20', N'Nữ', N'Hà Nội', N'456 Đường XYZ, Hà Nội', 'L002', 'K002', '987654321012', '0978643210', 'nguyenthb@gmail.com'),
    ('DLU223456', N'Trần Văn C', '2004-01-10', N'Nam', N'Hồ Chí Minh', N'789 Đường DEF, HCM', 'L003', 'K003', '456789012345', '0965432109', 'tranvc@gmail.com'),
    ('DTO210134', N'Phạm Thị D', '2003-12-25', N'Nữ', N'Hà Nội', N'101 Đường GHI, Hà Nội', 'L004', 'K004', '789012345678', '0901234567', 'phamtd@gmail.com'),
    ('DAV232131', N'Hồ Văn E', '2005-09-05', N'Nam', N'Hà Nội', N'111 Đường JKL, Hà Nội', 'L005', 'K005', '012345678901', '0912345678', 'hovane@gmail.com');


DELETE FROM PHONG
DELETE FROM HOPDONG
DELETE FROM HOADON

INSERT INTO NHANVIEN (MANHANVIEN, TENNHANVIEN, NGAYSINH, GIOITINH, NOISINH, DIACHI, CCCD, SDT, EMAIL)
VALUES
    ('NV0012345678', N'Nguyễn Văn X', '1985-03-12', N'Nam', N'Hà Nội', N'456 Đường XYZ, Hà Nội', '123456789012', '0987654321', 'nguyenvanx@gmail.com'),
    ('NV0012345679', N'Nguyễn Thị Y', '1986-06-18', N'Nữ', N'Hà Nội', N'789 Đường ABC, Hà Nội', '987654321012', '0978643210', 'nguyenthiy@gmail.com'),
    ('NV0012345680', N'Vũ Văn Z', '1987-10-03', N'Nam', N'Hồ Chí Minh', N'101 Đường DEF, HCM', '456789012345', '0965432109', 'vuvanz@gmail.com'),
    ('NV0012345681', N'Phạm Thị W', '1988-11-20', N'Nữ', N'Hà Nội', N'111 Đường GHI, Hà Nội', '789012345678', '0901234567', 'phamthiw@gmail.com'),
    ('NV0012345682', N'Hồ Văn U', '1989-08-09', N'Nam', N'Hà Nội', N'222 Đường JKL, Hà Nội', '012345678901', '0912345678', 'hovanu@gmail.com');




INSERT INTO HOPDONG (MAHOPDONG, MASINHVIEN, MANHANVIEN, MAPHONG, NGAYLAP, NGAYBATDAU, NGAYKETTHUC)
VALUES
    ('HD0012345688', 'DTH216134', 'NV0012345678', 'P0012345688', '2023-07-01', '2023-08-01', '2023-12-31'),
    ('HD0012345689', 'DQT202124', 'NV0012345679', 'P0012345689', '2023-07-15', '2023-08-15', '2024-01-31'),
    ('HD0012345690', 'DLU223456', 'NV0012345680', 'P0012345690', '2023-08-01', '2023-09-01', '2024-02-29'),
    ('HD0012345691', 'DTO210134', 'NV0012345681', 'P0012345691', '2023-08-15', '2023-09-15', '2024-03-31'),
    ('HD0012345692', 'DAV232131', 'NV0012345682', 'P0012345692', '2023-09-01', '2023-10-01', '2024-04-30');

INSERT INTO HOADON (MAHOADON, MANHANVIEN, MAPHONG, NGAYLAP, TIENDIEN, TIENNUOC)
VALUES
    ('HD006', 'NV0012345678', 'P0012345688', '2023-11-15', 25000, 20000),
    ('HD007', 'NV0012345679', 'P0012345689', '2023-11-16', 30000, 25000),
    ('HD008', 'NV0012345680', 'P0012345690', '2023-11-17', 40000, 35000),
    ('HD009', 'NV0012345681', 'P0012345691', '2023-11-18', 50000, 45000),
    ('HD010', 'NV0012345682', 'P0012345692', '2023-11-19', 60000, 55000);


SELECT * FROM HOADON


-- Cập nhật bảng HOADON để tính tổng tiền từ các khoản chi phí
UPDATE HOADON
SET TONGTIEN = TIENDIEN + TIENNUOC + (SELECT TIENPHONG FROM PHONG WHERE PHONG.MAPHONG = HOADON.MAPHONG);

SELECT hd.*, p.SOPHONG, p.TIENPHONG, nv.TENNHANVIEN
                        FROM HOADON hd, PHONG p, NHANVIEN nv
                        WHERE hd.MANHANVIEN = nv.MANHANVIEN AND hd.MAPHONG = p.MAPHONG